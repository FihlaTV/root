<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html lang="en">
<head>
<title>demo1</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=11" />
<meta http-equiv="Pragma" content="no-cache">
<style>
 body {
    font-family: "Lucida Console", Monaco, monospace;
    font-size: 11px;
    background: #111;
    color:#CCC;
}
</style>

<script src="./build/lab.min.js"></script>
<script src="./js/crowd.init.js"></script>

</head>

<body>
<script>

var h = 6;
var tt = 0;

var view = new View();
view.init(null, true);

var debug = document.createElement("div");
debug.style.cssText = 'position:absolute; bottom:10px; left:10px; width:200px;';
document.body.appendChild(debug);

crowd.init( onCrowdReady, onCrowdUpdate );

function onCrowdReady () {

    crowd.start();

    var i = 10;
    while(i--) obstacle();


    var i = 4;
    while(i--) agent();

}

function onCrowdUpdate () {

    //var heros = view.getHero()

    view.heros.forEach( function( b, id ) {

        var n = ( id * 5 );

        b.position.set( Gr[n+1], 1, Gr[n+2] );
        b.rotation.y = Gr[n+3];


    })

    tt++;

    if(tt===600) {
        tt = 0;
        randomGoal()
    }

}

function tell ( m ) {

  debug.textContent = m;

}

function randomGoal () {

    var lng = view.heros.length

    for(var i=0; i<lng; i++){

        crowd.send( 'goal', { id:i, x:Math.rand(-20,20), z:Math.rand(-20,20) } );

    };

}


function obstacle () {

    var m = new THREE.Mesh( view.geo.box, view.mat.donut )

    var sx = Math.rand(1,8);
    var sz = Math.rand(1,8);

    var px = Math.rand(-25,25)
    var pz = Math.rand(-25,25)

    var r = Math.rand(0,360) * Math.torad;

    m.scale.set(sx, 1, sz)
    m.position.set(px, 0.5, pz)
    m.rotation.y = r;

    m.castShadow = true;
    m.receiveShadow = true;

    view.scene.add(m)

    crowd.send( 'obstacle', { type:'box', pos:[px, 1, pz], size:[sx, 2, sz], r:r })



};

function agent () {


    var h = view.getHero()

    var s = 1.5

    var b = new THREE.Mesh( view.geo.cylinder, view.mat.basic )
    b.scale.set(0.5,0.25,0.5)
    b.position.y = -0.95
    var d = new THREE.Mesh( view.geo.wheel, view.mat.basic )
    d.scale.set(1,0.4,0.4)
    d.rotation.y = Math.PI90
    d.position.z = 0.5

    var c = new THREE.Mesh( view.geo.sphere, view.mat.basic )
    c.scale.set(0.5,0.5,0.5)
    c.position.y = 1.2

    var m = new THREE.Mesh( view.geo.sphere, view.mat.basic )
    m.add( b )
    m.add( d )
    m.add( c )

    m.castShadow = true;
    m.receiveShadow = true;

    m.scale.set(s,s,s);

    x = -8+(view.heros.length*4);
    y = -30;

    m.position.set( x, 1, y );

    view.scene.add(m)
    view.heros.push(m)

    crowd.send( 'add', { x:x, z:y, radius:s, speed:0.5 } );

};



/*function addGui (){

	var ui = new UIL.Gui();
	//ui.add('slide',  { name:'ao', min:0, max:2, value:1, step:0.01, precision:2, fontColor:'#B0CC99', h:20 }).onChange( changeAo );

}*/



</script>
</body>
</html>